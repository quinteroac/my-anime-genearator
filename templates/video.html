<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI Content Creator - Video</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/video.css') }}">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    {% raw %}
    <div id="video-app" class="video-generator-page">
        <header class="top-bar top-bar--minimal">
            <button class="header-icon-button" title="Settings" @click="openSettings">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19.5 13.5a7.8 7.8 0 0 0 0-3l2-1.6-1.5-3-2.4.9a7.9 7.9 0 0 0-2.6-1.5L14.7 2h-3.4l-.3 3.3a7.9 7.9 0 0 0-2.6 1.5l-2.4-.9-1.5 3 2 1.6a7.8 7.8 0 0 0 0 3l-2 1.6 1.5 3 2.4-.9a7.9 7.9 0 0 0 2.6 1.5l.3 3.3h3.4l.3-3.3a7.9 7.9 0 0 0 2.6-1.5l2.4.9 1.5-3-2-1.6z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <a href="{{ url_for('logout') }}" class="logout-icon" title="Logout">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 19a7 7 0 110-14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
        </header>

        <div class="video-generator-content">
            <div class="video-preview-panel">
                <div class="video-preview-header">
                    <button 
                        class="video-toggle-btn"
                        :class="{ active: previewMode === 'image' }"
                        @click="previewMode = 'image'"
                        :disabled="isGeneratingVideo"
                        title="Show source image"
                    >
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7l6 6-6 6"></path>
                        </svg>
                        Image
                    </button>
                    <button 
                        class="video-toggle-btn"
                        :class="{ active: previewMode === 'video' }"
                        @click="previewMode = 'video'"
                        :disabled="!videoResults.length || isGeneratingVideo"
                        title="Show generated videos"
                    >
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 5.5v13a1.5 1.5 0 002.287 1.264l10.5-6.5a1.5 1.5 0 000-2.528l-10.5-6.5A1.5 1.5 0 004.5 5.5z"></path>
                        </svg>
                        Video
                    </button>
                </div>

                <div class="video-preview-body">
                    <div 
                        v-if="previewMode === 'image'"
                        :class="['video-source-preview', (videoSourceImage && (videoSourceImage.filename || videoSourceImage.dataUrl)) ? 'has-image' : 'is-empty']"
                        :style="imageContainerStyle"
                    >
                        <template v-if="videoSourceImage && (videoSourceImage.filename || videoSourceImage.dataUrl)">
                            <div class="video-source-aspect" :style="{ paddingBottom: imageAspectRatioPadding }">
                                <img 
                                    :src="imageUrl"
                                    alt="Source image"
                                />
                            </div>
                        </template>
                        <p v-else class="video-placeholder">No source image provided.</p>
                    </div>
                    <div v-else class="video-results">
                        <p v-if="videoError" class="video-error">{{ videoError }}</p>
                        <div v-if="videoResults.length" class="video-result-list">
                            <div 
                                v-for="(video, index) in videoResults"
                                :key="`generated-video-${video.filename || index}`"
                                class="video-result-card"
                            >
                                <video 
                                    class="generated-video"
                                    :src="getVideoUrl(video)"
                                    controls
                                    playsinline
                                    preload="metadata"
                                ></video>
                                <div class="video-result-actions">
                                    <a 
                                        :href="getVideoUrl(video) + '&download=1'"
                                        class="video-download-btn"
                                        :download="video.filename || `generated-video-${index}.mp4`"
                                    >
                                        Download
                                    </a>
                                    <button
                                        type="button"
                                        class="video-drive-upload-btn"
                                        @click="uploadVideoToDrive(video)"
                                        :disabled="isUploadingToDrive"
                                        :title="driveAuthenticated ? 'Upload to Google Drive' : 'Authorize Google Drive'"
                                    >
                                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                    </button>
                                    <button
                                        type="button"
                                        class="video-extend-btn"
                                        @click="extendVideo(video, index)"
                                        :disabled="isGeneratingVideo || isExtendingVideo || !canExtendVideo(video)"
                                    >
                                        <span v-if="isExtendingVideo && extendingVideoId === getVideoIdentifier(video, index)">
                                            Extending...
                                        </span>
                                        <span v-else>
                                            Extend
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p v-else class="video-placeholder">Generate a video to see results here.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-group video-input-group">
            <div class="prompt-textfield-container">
                <button 
                    class="prompt-control-btn new-prompt-inline"
                    @click="goBack"
                    :disabled="isGeneratingVideo"
                    title="Back to Images"
                >
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <button 
                    class="generate-btn-inline"
                    @click="generateVideo"
                    :disabled="isGeneratingVideo"
                    title="Generate Video"
                >
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                    </svg>
                </button>
                <textarea 
                    v-model="videoPrompt"
                    ref="videoPromptInput"
                    class="prompt-textarea-field"
                    :disabled="isGeneratingVideo"
                    placeholder="Describe what you want to generate..."
                ></textarea>
                <div class="prompt-controls">
                    <div class="prompt-controls-left"></div>
                    <div class="prompt-controls-right">
                        <label class="nsfw-toggle-label" :disabled="isGeneratingVideo">
                            <input 
                                type="checkbox" 
                                v-model="enableNSFW"
                                :disabled="isGeneratingVideo"
                                class="nsfw-toggle-checkbox"
                                @change="if (enableNSFW) enableNoSound = false"
                            />
                            <span class="nsfw-toggle-text">NSFW</span>
                        </label>
                        <label class="nsfw-toggle-label" :disabled="isGeneratingVideo || enableNSFW">
                            <input 
                                type="checkbox" 
                                v-model="enableNoSound"
                                :disabled="isGeneratingVideo || enableNSFW"
                                class="nsfw-toggle-checkbox"
                            />
                            <span class="nsfw-toggle-text">Sin Sonido</span>
                        </label>
                        <select 
                            v-model="selectedOrientation" 
                            class="aspect-ratio-select"
                            :disabled="isGeneratingVideo"
                            title="Aspect Ratio"
                        >
                            <option 
                                v-for="option in videoResolutionOptions" 
                                :key="option.key" 
                                :value="option.key"
                            >
                                {{ option.label }} ({{ option.video }})
                            </option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showSettingsModal" class="settings-modal-backdrop" @click.self="closeSettings">
            <div class="settings-modal">
                <h2 class="settings-title">Settings</h2>
                <div class="settings-section">
                    <h3 class="settings-section-title">ComfyUI Endpoints</h3>
                    <label class="settings-label" for="video-settings-comfy-endpoint-generate">Generate Endpoint</label>
                    <input
                        id="video-settings-comfy-endpoint-generate"
                        class="settings-input"
                        type="text"
                        v-model="settingsEndpoints.generate"
                        @input="handleSettingsInput"
                        placeholder="http://localhost:8188"
                        :disabled="isSavingSettings"
                    />
                    <label class="settings-label" for="video-settings-comfy-endpoint-edit">Edit Endpoint</label>
                    <input
                        id="video-settings-comfy-endpoint-edit"
                        class="settings-input"
                        type="text"
                        v-model="settingsEndpoints.edit"
                        @input="handleSettingsInput"
                        placeholder="http://localhost:8189"
                        :disabled="isSavingSettings"
                    />
                    <label class="settings-label" for="video-settings-comfy-endpoint-video">Video Endpoint</label>
                    <input
                        id="video-settings-comfy-endpoint-video"
                        class="settings-input"
                        type="text"
                        v-model="settingsEndpoints.video"
                        @input="handleSettingsInput"
                        placeholder="http://localhost:8190"
                        :disabled="isSavingSettings"
                    />
                </div>
                <p v-if="settingsError" class="settings-feedback settings-error">{{ settingsError }}</p>
                <p v-if="settingsSaved" class="settings-feedback settings-success">Endpoints updated successfully.</p>
                <div class="settings-actions">
                    <button class="settings-button secondary" type="button" @click="closeSettings" :disabled="isSavingSettings">Cancel</button>
                    <button class="settings-button primary" type="button" @click="saveSettings" :disabled="isSavingSettings">
                        <span v-if="isSavingSettings">Saving...</span>
                        <span v-else>Save</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script id="video-data-json" type="application/json">{{ video_data | tojson | safe }}</script>
    <script>
        window.__VIDEO_PAGE_DATA__ = JSON.parse(document.getElementById('video-data-json').textContent);
    </script>
    <script src="{{ url_for('static', filename='js/video.js') }}"></script>
</body>
</html>

